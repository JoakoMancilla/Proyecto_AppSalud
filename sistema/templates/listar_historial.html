{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8"/>
    <title>Historial - RedSalud Regional</title>
    <link rel="icon" href="{% static 'img/logo.png' %}"/>

    <!-- Bootstrap & Fonts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <style>
        body {
            background: linear-gradient(135deg, #e8f3ff 0%, #f2f7ff 100%);
            font-family: 'Inter', sans-serif;
        }

        /* BOTONES FLOTANTES */
        .scroll-btn {
            position: fixed;
            right: 25px;
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: #0d6efd;
            border: none;
            color: white;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: 0.25s ease;
            z-index: 999;
        }

        .scroll-btn:hover {
            background: #0b5ed7;
        }

        #btnUp { bottom: 90px; }
        #btnDown { bottom: 30px; }

        /* NAVBAR */
        .nav-glass {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.55);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.07);
        }

        .nav-link {
            font-weight: 600;
            color: #0d6efd !important;
            margin-right: 10px;
        }

        .navbar-brand {
            color: #0d6efd !important;
            font-weight: 700;
            font-size: 1.4rem;
        }

        .card-modern {
            backdrop-filter: blur(18px);
            background: rgba(255, 255, 255, 0.75);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .table {
            border-radius: 16px;
            overflow: hidden;
        }

        thead {
            background: #e3f2fd;
        }

        thead th {
            font-weight: 700;
        }

        tbody tr:hover {
            background: rgba(13, 110, 253, 0.10);
            transform: scale(1.01);
        }

        footer {
            color: #6c757d;
            opacity: 0.8;
            margin-top: 3rem;
        }
    </style>

    <!-- SCRIPT DEL FILTRO -->
    <script>
        function cambiarInputHistorial() {
            const campo = document.querySelector("select[name='campo']").value;
            const contenedor = document.getElementById("contenedor-input-his");

            contenedor.innerHTML = "";

            if (campo === "usuario") {
                contenedor.innerHTML = `
                    <input type="text" name="txtfil" class="form-control form-control-lg"
                    placeholder="Nombre del usuario">
                `;
            }
            else if (campo === "accion") {
                contenedor.innerHTML = `
                    <input type="text" name="txtfil" class="form-control form-control-lg"
                    placeholder="Acción realizada">
                `;
            }
            else if (campo === "tabla") {
                contenedor.innerHTML = `
                    <input type="text" name="txtfil" class="form-control form-control-lg"
                    placeholder="Tabla afectada">
                `;
            }
            else if (campo === "fecha") {
                contenedor.innerHTML = `
                    <input type="date" name="txtfil" class="form-control form-control-lg">
                `;
            }
            else {
                contenedor.innerHTML = `
                    <input type="text" name="txtfil" class="form-control form-control-lg"
                    placeholder="Ingrese texto a buscar">
                `;
            }
        }

        document.addEventListener("DOMContentLoaded", cambiarInputHistorial);

        const botonCerrarSesion = () => {
            if (window.confirm("¿Está seguro de querer cerrar la sesión?")) {
                window.location.href = "/logout";
            }
        };

        function scrollUp() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function scrollDown() { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }
    </script>
</head>

<body>

<!-- BOTONES FLOTANTES -->
<button id="btnUp" class="scroll-btn" onclick="scrollUp()"><i class="bi bi-arrow-up"></i></button>
<button id="btnDown" class="scroll-btn" onclick="scrollDown()"><i class="bi bi-arrow-down"></i></button>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg nav-glass py-3">
    <div class="container-fluid px-4">
        <a class="navbar-brand" href="/menu/">
            <i class="bi bi-hospital"></i> RedSalud Regional
        </a>

        <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto ms-3">
                <li class="nav-item"><a class="nav-link" href="/menu/">Inicio</a></li>

                {% if nomUsuario == 'ADMIN' %}
                <li class="nav-item"><a class="nav-link" href="/historial/">Historial</a></li>
                <li class="nav-item"><a class="nav-link" href="/mostrarActualizarCamas/">Camas</a></li>
                {% else %}
                <li class="nav-item"><a class="nav-link" href="/registrarPaciente/">Registrar</a></li>
                <li class="nav-item"><a class="nav-link" href="/listarPacientes/">Pacientes</a></li>
                {% endif %}
            </ul>

            <div class="d-flex align-items-center">
                <span class="me-3 fw-bold text-primary">{{ nomUsuario }}</span>
                <button onclick="botonCerrarSesion()" class="btn btn-outline-primary btn-sm">Cerrar sesión</button>
            </div>
        </div>
    </div>
</nav>

<!-- ALERTA -->
{% if r %}
<div class="alert alert-success alert-dismissible fade show mt-3 container" role="alert">
    <h5 class="m-0">{{ r }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- CONTENIDO -->
<div class="container my-5">
    <div class="card-modern mx-auto" style="max-width: 1100px;">
        <h2 class="text-center fw-bold text-primary mb-4">Historial de Acciones del Sistema</h2>

        <!-- FILTRO -->
        <form action="/filtrarHistorial/" method="POST" class="row mb-4 g-3 justify-content-center">
            {% csrf_token %}

            <div class="col-md-3">
                <select name="campo" class="form-select form-select-lg" onchange="cambiarInputHistorial()">
                    <option value="todos">Todos</option>
                    <option value="usuario">Usuario</option>
                    <option value="accion">Acción</option>
                    <option value="tabla">Tabla</option>
                    <option value="fecha">Fecha</option>
                </select>
            </div>

            <div class="col-md-5" id="contenedor-input-his">
                <!-- Aquí cambia dinámicamente -->
            </div>

            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="bi bi-search me-1"></i> Buscar
                </button>
            </div>
        </form>

        {% if his %}
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle mb-0">
                <thead class="text-center">
                    <tr>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>Acción</th>
                        <th>Tabla</th>
                        <th>Fecha y Hora</th>
                    </tr>
                </thead>
                <tbody>
                    {% for x in his %}
                    <tr class="text-center">
                        <td>{{ x.id }}</td>
                        <td>{{ x.usuario.nombre }}</td>
                        <td>{{ x.descripcion_historial }}</td>
                        <td>{{ x.tabla_afectada_historial }}</td>
                        <td>{{ x.fecha_hora_historial }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% else %}
        <h4 class="text-center text-muted mt-4">
            <i class="bi bi-exclamation-circle me-2"></i>
            No hay acciones registradas.
        </h4>
        {% endif %}
    </div>
</div>

<footer class="text-center py-3 small">
    © 2025 RedSalud Regional — Sistema de Gestión de Pacientes
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
